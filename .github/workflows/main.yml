name: Ubuntu XFCE noVNC with LocalXpose

on: [workflow_dispatch]

jobs:
  run-desktop:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Ubuntu XFCE Desktop
      run: |
        sudo apt update
        sudo apt install -y curl git wget xfce4 xfce4-goodies tightvncserver novnc websockify
        vncserver :1
        vncserver -kill :1
        mkdir -p ~/.vnc
        echo '#!/bin/bash\nxrdb $HOME/.Xresources\nstartxfce4 &' > ~/.vnc/xstartup
        chmod +x ~/.vnc/xstartup
        echo "kali12345S" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd

    - name: Download and Setup noVNC
      run: |
        git clone https://github.com/novnc/noVNC.git ~/noVNC
        git clone https://github.com/novnc/websockify.git ~/noVNC/utils/websockify

    - name: Start VNC and noVNC Servers
      run: |
        vncserver :1 -geometry 1280x720 -depth 24
        nohup ~/noVNC/utils/launch.sh --vnc localhost:5901 --listen 6080 &

    - name: Install LocalXpose
      run: |
        curl -sLo lx https://localxpose.io/releases/v1.4.11/localxpose-linux-amd64
        chmod +x lx

    - name: Start LocalXpose Tunnel (Port 6080)
      run: |
        ./lx authtoken DgN6KiykIQ1cb7XvcoaYz2AXX68yIwvUndjYfchQ
        ./lx tunnel http --port 6080 &
        sleep 5
        curl -s https://api.localxpose.io/api/v2/tunnels > tunnel.json
        cat tunnel.json

    - name: Done! Print Access Instructions
      run: |
        echo "ðŸŽ‰ XFCE Desktop is now running!"
        echo "ðŸ”— Your noVNC session should be accessible through the LocalXpose tunnel above (check logs for the exact URL)."
