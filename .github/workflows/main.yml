name: Ubuntu GUI with LocalXpose Tunnel

on: workflow_dispatch

jobs:
  ubuntu-desktop:
    runs-on: ubuntu-latest

    steps:
    - name: Set up LocalXpose
      run: |
        sudo apt update
        sudo apt install -y unzip curl wget xfce4 xfce4-goodies tightvncserver x11vnc dbus-x11

        # Start dbus
        sudo service dbus start

        # Start VNC server (port 5900)
        vncserver :0
        export DISPLAY=:0

        # Download LocalXpose binary dynamically
        url=$(curl -sI https://api.localxpose.io/api/v2/downloads/lx-linux-amd64.zip | grep -i Location | awk '{print $2}' | tr -d '\r')
        wget "$url" -O lx.zip
        unzip lx.zip
        chmod +x lx
        ./lx auth DgN6KiykIQ1cb7XvcoaYz2AXX68yIwvUndjYfchQ
        ./lx tunnel tcp --port 5900 &

        # Install noVNC
        git clone https://github.com/novnc/noVNC.git
        cd noVNC
        git clone https://github.com/novnc/websockify
        ./utils/novnc_proxy --vnc localhost:5900 &
        
        echo "Everything is up! You can now access your desktop via LocalXpose TCP tunnel and noVNC."
