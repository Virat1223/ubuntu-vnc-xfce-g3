name: Ubuntu XFCE Desktop via noVNC

on: [workflow_dispatch]

jobs:
  ubuntu-gui:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours

    steps:
    - name: Set up environment
      run: |
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies tightvncserver git curl wget python3 net-tools

    - name: Set VNC password
      run: |
        mkdir -p ~/.vnc
        echo "123456" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd

    - name: Start VNC server
      run: |
        vncserver :1
        vncserver -kill :1
        echo '#!/bin/bash\nxrdb $HOME/.Xresources\nstartxfce4 &' > ~/.vnc/xstartup
        chmod +x ~/.vnc/xstartup
        vncserver :1

    - name: Clone noVNC and Websockify
      run: |
        git clone https://github.com/novnc/noVNC.git
        git clone https://github.com/novnc/websockify.git noVNC/utils/websockify

    - name: Start noVNC server
      run: |
        nohup ./noVNC/utils/novnc_proxy --vnc localhost:5901 --listen 6080 > novnc.log 2>&1 &

    - name: Download LocalXpose binary
      run: |
        curl -L https://api.localxpose.io/api/v2/downloads/linux/amd64 -o lx
        chmod +x lx

    - name: Start LocalXpose tunnel
      run: |
        ./lx tunnel http --to 127.0.0.1:6080 --token DgN6KiykIQ1cb7XvcoaYz2AXX68yIwvUndjYfchQ
